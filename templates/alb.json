{
  "application": {
    "request_count": {
      "name"             : "request_count: ${local.lb_name}",
      "type"             : "metric alert",
      "query"            : "avg(last_4h):anomalies(sum:aws.applicationelb.request_count{host:${aws_lb.lb.dns_name}} by {host}.as_count(), 'basic', 2, direction='above', alert_window='last_15m', interval=60, count_default_zero='true') >= 1",
      "message"          : "Request count monitor triggered for ${local.lb_name}. Throughput monitoring on number of requests ELB received and sent to registered instances. Notify: ${var.dd_notification_targets}",
      "renotify_interval": 15,
      "notify_no_data"   : true,
      "no_data_timeframe": 30,
      "evaluation_delay" : 900,
      "monitor_thresholds": {
        "critical"         : 1,
        "critical_recovery": 0
      },
      "monitor_threshold_windows": {
        "trigger_window" : "last_15m",
        "recovery_window": "last_15m"
      }
    },
    "httpcode_elb_5xx": {
      "name"            : "HTTPCode_elb_5XX: ${local.lb_name}",
      "type"            : "metric alert",
      "query"           : "sum(last_5m):sum:aws.applicationelb.httpcode_elb_5xx{host:${aws_lb.lb.dns_name}} by {host}.as_count() > 0",
      "message"         : "HTTPCode_elb_5XX monitor triggered for ${local.lb_name}. Error monitoring on number of HTTP 5xx errors returned by the load balancer. Notify: ${var.dd_notification_targets}",
      "evaluation_delay": 900,
      "new_group_delay" : 60,
      "monitor_thresholds": {
        "critical": 0
      }
    },
    "target_response_time": {
      "name"            : "target_response_time: ${local.lb_name}",
      "type"            : "metric alert",
      "query"           : "avg(last_5m):avg:aws.applicationelb.target_response_time.average{host:${aws_lb.lb.dns_name}} by {host} > 1",
      "message"         : "target_response_time monitor triggered for ${local.lb_name}. Performance monitoring on request-processing time between load balancer and backend. Notify: ${var.dd_notification_targets}",
      "evaluation_delay": 900,
      "new_group_delay" : 60,
      "monitor_thresholds": {
        "critical": 1,
        "warning" : 0.6
      }
    },
    "target_connection_error_count": {
      "name"            : "target_connection_error_count: ${local.lb_name}",
      "type"            : "metric alert",
      "query"           : "sum(last_5m):sum:aws.applicationelb.target_connection_error_count{host:${aws_lb.lb.dns_name}}.as_count() > 0",
      "message"         : "target_connection_error_count monitor triggered for ${local.lb_name}. Error monitoring on number of attempted but failed connections between the load balancer and backend instance. Notify: ${var.dd_notification_targets}",
      "evaluation_delay": 900,
      "monitor_thresholds": {
        "critical": 0
      }
    }
  }
}
